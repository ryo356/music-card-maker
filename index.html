<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Music Card Maker</title>
  <meta name="theme-color" content="#0b1020">
  <style>
    :root{
      --bg:#0b1020;
      --card: rgba(18,26,51,.78);
      --card2: rgba(18,26,51,.72);
      --ink:#e9ecff;
      --muted:#aab2d5;
      --accent:#53f3a6;
      --border: rgba(255,255,255,.10);
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius: 18px;
      --pad: 14px;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-top: env(safe-area-inset-top, 0px);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Sans", "Yu Gothic", "Meiryo", sans-serif;
      color:var(--ink);
      background:
        radial-gradient(900px 650px at 20% 10%, rgba(83,243,166,.18), transparent 60%),
        radial-gradient(900px 650px at 85% 30%, rgba(120,140,255,.18), transparent 60%),
        var(--bg);
      min-height: 100vh;
      padding-bottom: calc(92px + var(--safe-bottom));
      padding-top: var(--safe-top);
    }

    header{
      position: sticky;
      top: 0;
      z-index: 5;
      backdrop-filter: blur(10px);
      background: rgba(11,16,32,.55);
      border-bottom: 1px solid rgba(255,255,255,.07);
    }
    .headInner{
      max-width: 980px;
      margin: 0 auto;
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .brand{
      display:flex; flex-direction:column; gap:2px;
    }
    .brand b{ font-size: 14px; letter-spacing:.02em; }
    .brand span{ font-size: 11px; color: var(--muted); }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 14px;
      display:grid;
      gap: 14px;
    }

    .panel{
      background: rgba(18,26,51,.55);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .panelInner{ padding: var(--pad); }

    .row{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .grid{
      display:grid;
      gap: 10px;
    }
    @media(min-width: 860px){
      .wrap{
        grid-template-columns: 1.15fr .85fr;
        align-items: start;
      }
      .previewCard{ position: sticky; top: 70px; }
    }

    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin: 0 0 6px;
    }
    input[type="text"], input[type="number"], textarea, select{
      width: 100%;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--ink);
      border-radius: 14px;
      padding: 12px 12px;
      outline: none;
      font-size: 16px; /* iOS zoomé˜²æ­¢ */
    }
    textarea{
      min-height: 140px;
      resize: vertical;
      line-height: 1.6;
    }
    input[type="file"]{
      width:100%;
      padding: 10px 0;
      color: var(--muted);
      font-size: 14px;
    }
    .hint{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.5;
    }

    .seg{
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
    }
    .chip{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      padding: 10px 12px;
      border-radius: 999px;
      color: var(--ink);
      cursor:pointer;
      user-select:none;
      font-size: 13px;
      font-weight: 700;
      letter-spacing:.01em;
      transition: transform .06s ease, background .2s ease, border-color .2s ease;
      min-height: 40px; /* ã‚¿ãƒƒãƒ—ã—ã‚„ã™ã */
    }
    .chip:active{ transform: translateY(1px); }
    .chip.on{
      background: rgba(83,243,166,.16);
      border-color: rgba(83,243,166,.35);
    }

    canvas{
      width:100%;
      height:auto;
      display:block;
      background: rgba(0,0,0,.10);
      border-top: 1px solid rgba(255,255,255,.06);
    }

    .bottomBar{
      position: fixed;
      left:0; right:0; bottom:0;
      z-index: 10;
      padding: 10px 14px calc(10px + var(--safe-bottom));
      background: rgba(11,16,32,.78);
      backdrop-filter: blur(12px);
      border-top: 1px solid rgba(255,255,255,.10);
    }
    .barInner{
      max-width: 980px;
      margin: 0 auto;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
    }
    .btn{
      cursor:pointer;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(83,243,166,.14);
      color: var(--ink);
      padding: 14px 12px;
      border-radius: 16px;
      font-weight: 900;
      letter-spacing:.02em;
      user-select:none;
      min-height: 48px; /* ã‚¿ãƒƒãƒ—ã—ã‚„ã™ã */
      font-size: 14px;
    }
    .btn.secondary{ background: rgba(255,255,255,.07); font-weight: 800; }
    .btn.danger{ background: rgba(255,80,120,.14); }

    .mini{
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
    }
    .note{
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.08);
      color: var(--muted);
      font-size: 12px;
      line-height: 1.5;
      margin-top: 10px;
    }

    .two{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media(max-width: 420px){
      .two{ grid-template-columns: 1fr; }
      .barInner{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<header>
  <div class="headInner">
    <div class="brand">
      <b>ğŸ§ Music Card Maker</b>
      <span>å†ç”Ÿç”»é¢ï¼‹ã‚¸ãƒ£ã‚±å†™ï¼‹æ­Œè©ï¼ˆçŸ­æ–‡ï¼‰â†’ PNG</span>
    </div>
    <div class="hint" id="status">cover: æœªé¸æŠ</div>
  </div>
</header>

<div class="wrap">
  <!-- Inputs -->
  <section class="panel">
    <div class="panelInner">
      <div class="grid">
        <div class="two">
          <div>
            <label>æ›²å</label>
            <input id="title" type="text" placeholder="ä¾‹ï¼šæ˜¥é›·" />
          </div>
          <div>
            <label>ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ</label>
            <input id="artist" type="text" placeholder="ä¾‹ï¼šç±³æ´¥ç„å¸«" />
          </div>
        </div>

        <div>
          <label>ã‚¸ãƒ£ã‚±å†™ï¼ˆç”»åƒï¼‰</label>
          <input id="cover" type="file" accept="image/*" />
          <div class="hint">â€»ã‚¹ã‚¯ã‚·ãƒ§ã§ã‚‚OKã€‚ç”»åƒã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…ã ã‘ã§å‡¦ç†ã€‚</div>
        </div>

        <div class="two">
          <div>
            <label>ãƒ†ãƒ³ãƒ—ãƒ¬</label>
            <div class="seg">
              <div class="chip on" data-template="portrait">ç¸¦ï¼ˆãŠã™ã™ã‚ï¼‰</div>
              <div class="chip" data-template="square">æ­£æ–¹å½¢</div>
              <div class="chip" data-template="landscape">æ¨ªé•·</div>
            </div>
          </div>
          <div>
            <label>ãƒ†ãƒ¼ãƒ</label>
            <div class="seg">
              <div class="chip on" data-theme="dark">Dark</div>
              <div class="chip" data-theme="crimson">Crimson</div>
              <div class="chip" data-theme="mono">Mono</div>
            </div>
          </div>
        </div>

        <div class="two">
          <div>
            <label>æ›²ã®é•·ã•ï¼ˆç§’ï¼‰</label>
            <input id="duration" type="number" min="1" inputmode="numeric" />
          </div>
          <div>
            <label>å†ç”Ÿä½ç½®ï¼ˆç§’ï¼‰</label>
            <input id="pos" type="number" min="0" inputmode="numeric" />
          </div>
        </div>

        <div>
          <label>æ­Œè© / ãƒ¡ãƒ¢ï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰</label>
          <textarea id="lyrics" placeholder="çŸ­ã„å¼•ç”¨ or è‡ªåˆ†ã®ãƒ¡ãƒ¢æ¨å¥¨ã€‚è¡Œã§ãã‚Œã£ã½ããªã‚‹ã‚ˆã€‚"></textarea>
          <div class="hint">å…±æœ‰ã™ã‚‹ãªã‚‰çŸ­æ–‡æ¨å¥¨ï¼ˆæ¨©åˆ©é…æ…®ï¼‰ã€‚</div>
        </div>

        <div class="note">
          âš ï¸ ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ã€Œå€‹äººåˆ©ç”¨ / çŸ­ã„å¼•ç”¨ / ãƒ¡ãƒ¢ç”¨é€”ã€ã‚’æƒ³å®šã€‚æ­Œè©å…¨æ–‡ã®å…¬é–‹ãƒ»é…å¸ƒã¯æƒ³å®šã—ã¦ã¾ã›ã‚“ã€‚
        </div>

        <div class="mini">å…¥åŠ›ã¯è‡ªå‹•ä¿å­˜ã•ã‚Œã‚‹ã‚ˆï¼ˆæ¬¡å›é–‹ã„ãŸã‚‰å¾©å…ƒï¼‰ã€‚</div>
      </div>
    </div>
  </section>

  <!-- Preview -->
  <section class="panel previewCard">
    <div class="panelInner">
      <div class="row" style="justify-content:space-between; align-items:flex-end;">
        <div>
          <div style="font-weight:900">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
          <div class="hint">ã“ã“ãŒãã®ã¾ã¾PNGã«ãªã‚‹</div>
        </div>
        <div class="hint" id="dim">1080 Ã— 1350</div>
      </div>
    </div>
    <canvas id="cvs" width="1080" height="1350"></canvas>
  </section>
</div>

<!-- Bottom action bar -->
<div class="bottomBar">
  <div class="barInner">
    <button class="btn" id="render">ç”Ÿæˆ</button>
    <button class="btn secondary" id="download">PNGä¿å­˜</button>
    <button class="btn danger" id="reset">ãƒªã‚»ãƒƒãƒˆ</button>
  </div>
</div>

<script>
  const $ = (id) => document.getElementById(id);

  const cvs = $("cvs");
  const ctx = cvs.getContext("2d");

  let coverImg = null;

  // --------- templates & themes ----------
  const TEMPLATES = {
    portrait: { w: 1080, h: 1350 },
    square:   { w: 1080, h: 1080 },
    landscape:{ w: 1600, h: 900  }
  };

  const THEMES = {
    dark:    { bg:"#0b1020", card:"rgba(18,26,51,.78)", card2:"rgba(18,26,51,.72)", ink:"rgba(233,236,255,.96)", muted:"rgba(170,178,213,.95)", accent:"rgba(83,243,166,.92)" },
    crimson: { bg:"#190812", card:"rgba(40,12,24,.70)", card2:"rgba(40,12,24,.62)", ink:"rgba(255,240,246,.96)", muted:"rgba(255,200,220,.85)", accent:"rgba(255,90,140,.92)" },
    mono:    { bg:"#0b0b0f", card:"rgba(240,240,245,.10)", card2:"rgba(240,240,245,.08)", ink:"rgba(245,245,250,.96)", muted:"rgba(200,205,220,.85)", accent:"rgba(245,245,250,.92)" }
  };

  let state = {
    template: "portrait",
    theme: "dark",
    title: "æ˜¥é›·",
    artist: "ç±³æ´¥ç„å¸«",
    duration: 206,
    pos: 103,
    lyrics: "ä¾‹ãˆã°ã€ã“ã“ã«çŸ­ã„å¼•ç”¨ã‚„ãƒ¡ãƒ¢ã‚’å…¥ã‚Œã‚‹ã€‚\nè¡Œã§ãã‚Œã£ã½ããªã‚‹ã€‚\nï¼ˆå…±æœ‰ã™ã‚‹ãªã‚‰çŸ­ã‚æ¨å¥¨ï¼‰"
  };

  const STORAGE_KEY = "music_card_maker_v1";

  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

  function formatTime(sec){
    sec = Math.max(0, Math.floor(sec));
    const m = Math.floor(sec / 60);
    const s = sec % 60;
    return `${m}:${String(s).padStart(2,"0")}`;
  }

  function roundRect(ctx, x, y, w, h, r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }

  function shadowed(draw){
    ctx.save();
    ctx.shadowColor = "rgba(0,0,0,.35)";
    ctx.shadowBlur = 40;
    ctx.shadowOffsetY = 18;
    draw();
    ctx.restore();
  }

  function applyTemplate(){
    const t = TEMPLATES[state.template];
    cvs.width = t.w;
    cvs.height = t.h;
    $("dim").textContent = `${t.w} Ã— ${t.h}`;
  }

  function applyThemeToCSS(){
    const th = THEMES[state.theme];
    document.documentElement.style.setProperty("--bg", th.bg);
    document.documentElement.style.setProperty("--accent", th.accent);
    document.documentElement.style.setProperty("--card", th.card);
    document.documentElement.style.setProperty("--card2", th.card2);
  }

  function drawBackground(th){
    ctx.clearRect(0,0,cvs.width,cvs.height);

    // base
    ctx.fillStyle = th.bg;
    ctx.fillRect(0,0,cvs.width,cvs.height);

    // gradients (theme-aware)
    const g1 = ctx.createRadialGradient(cvs.width*0.25, cvs.height*0.12, 10, cvs.width*0.25, cvs.height*0.12, Math.max(cvs.width,cvs.height)*0.75);
    g1.addColorStop(0, state.theme==="crimson" ? "rgba(255,90,140,.18)" : "rgba(83,243,166,.18)");
    g1.addColorStop(1, "rgba(0,0,0,0)");
    ctx.fillStyle = g1;
    ctx.fillRect(0,0,cvs.width,cvs.height);

    const g2 = ctx.createRadialGradient(cvs.width*0.85, cvs.height*0.28, 10, cvs.width*0.85, cvs.height*0.28, Math.max(cvs.width,cvs.height)*0.78);
    g2.addColorStop(0, state.theme==="crimson" ? "rgba(255,200,220,.14)" : "rgba(120,140,255,.18)");
    g2.addColorStop(1, "rgba(0,0,0,0)");
    ctx.fillStyle = g2;
    ctx.fillRect(0,0,cvs.width,cvs.height);

    // vignette
    const v = ctx.createLinearGradient(0,0,0,cvs.height);
    v.addColorStop(0,"rgba(0,0,0,.10)");
    v.addColorStop(1,"rgba(0,0,0,.35)");
    ctx.fillStyle = v;
    ctx.fillRect(0,0,cvs.width,cvs.height);
  }

  // Layout per template
  function layout(){
    const W=cvs.width, H=cvs.height;

    if(state.template==="portrait"){
      return {
        player: { x: 70, y: 80,  w: W-140, h: 620 },
        lyrics: { x: 70, y: 740, w: W-140, h: H-740-70 }
      };
    }
    if(state.template==="square"){
      return {
        player: { x: 70, y: 70,  w: W-140, h: 520 },
        lyrics: { x: 70, y: 610, w: W-140, h: H-610-70 }
      };
    }
    // landscape
    const pad = 70;
    const gap = 40;
    const leftW = Math.floor((W - pad*2 - gap) * 0.52);
    const rightW = (W - pad*2 - gap) - leftW;
    return {
      player: { x: pad, y: 90, w: leftW, h: H-180 },
      lyrics: { x: pad+leftW+gap, y: 90, w: rightW, h: H-180 }
    };
  }

  function drawPlayerCard(th, box){
    shadowed(()=>{
      roundRect(ctx, box.x, box.y, box.w, box.h, 34);
      ctx.fillStyle = th.card;
      ctx.fill();
      ctx.strokeStyle = "rgba(255,255,255,.10)";
      ctx.lineWidth = 2;
      ctx.stroke();
    });

    // cover square (responsive)
    const margin = 46;
    const coverSize = Math.min(360, Math.floor(box.w*0.42));
    const cx = box.x + margin;
    const cy = box.y + margin;
    const cw = coverSize;
    const ch = coverSize;

    shadowed(()=>{
      roundRect(ctx, cx,cy,cw,ch, 24);
      ctx.fillStyle = "rgba(0,0,0,.18)";
      ctx.fill();
    });

    if (coverImg){
      const img = coverImg;
      const ir = img.width / img.height;
      const tr = cw / ch;
      let sx=0, sy=0, sw=img.width, sh=img.height;
      if (ir > tr){
        sh = img.height;
        sw = sh * tr;
        sx = (img.width - sw)/2;
      } else {
        sw = img.width;
        sh = sw / tr;
        sy = (img.height - sh)/2;
      }
      ctx.save();
      roundRect(ctx, cx,cy,cw,ch, 24);
      ctx.clip();
      ctx.drawImage(img, sx,sy,sw,sh, cx,cy,cw,ch);
      ctx.restore();
    } else {
      ctx.fillStyle = "rgba(255,255,255,.12)";
      ctx.font = "800 18px ui-sans-serif, system-ui";
      ctx.textAlign = "center";
      ctx.fillText("ã‚¸ãƒ£ã‚±å†™ã‚’å…¥ã‚Œã¦ã­", cx+cw/2, cy+ch/2);
    }

    // text area
    const tx = cx + cw + 38;
    const maxTextW = box.x + box.w - tx - 40;

    ctx.textAlign = "left";
    ctx.fillStyle = th.ink;
    ctx.font = "900 40px ui-sans-serif, system-ui";
    drawEllipsis(state.title || "ï¼ˆæ›²åï¼‰", tx, box.y + 120, maxTextW);

    ctx.fillStyle = th.muted;
    ctx.font = "800 24px ui-sans-serif, system-ui";
    drawEllipsis(state.artist || "ï¼ˆã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆï¼‰", tx, box.y + 165, maxTextW);

    // progress
    const duration = Math.max(1, Number(state.duration)||1);
    const pos = clamp(Number(state.pos)||0, 0, duration);

    const barW = Math.min(520, Math.floor(box.w*0.62));
    const barX = tx;
    const barY = box.y + box.h - 170;
    const barH = 10;

    ctx.fillStyle = "rgba(255,255,255,.18)";
    roundRect(ctx, barX,barY,barW,barH, 8);
    ctx.fill();

    const pW = Math.max(8, barW*(pos/duration));
    ctx.fillStyle = th.accent;
    roundRect(ctx, barX,barY,pW,barH, 8);
    ctx.fill();

    ctx.beginPath();
    ctx.arc(barX+pW, barY+barH/2, 12, 0, Math.PI*2);
    ctx.fillStyle = th.ink;
    ctx.fill();

    ctx.fillStyle = th.muted;
    ctx.font = "800 18px ui-sans-serif, system-ui";
    ctx.fillText(formatTime(pos), barX, barY+40);
    const end = formatTime(duration);
    const endW = ctx.measureText(end).width;
    ctx.fillText(end, barX+barW-endW, barY+40);

    // controls (simple)
    const baseY = box.y + box.h - 90;
    const centerX = barX + Math.min(barW, 460) * 0.55;
    const gap = 78;

    iconPrev(centerX-gap, baseY, th.ink);
    iconPlay(centerX, baseY, th.ink, th.card);
    iconNext(centerX+gap, baseY, th.ink);

    // tiny dots for shuffle/repeat
    ctx.fillStyle = "rgba(170,178,213,.65)";
    ctx.beginPath(); ctx.arc(barX+40, baseY, 7, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(barX+barW-40, baseY, 7, 0, Math.PI*2); ctx.fill();
  }

  function drawLyricsCard(th, box){
    shadowed(()=>{
      roundRect(ctx, box.x, box.y, box.w, box.h, 34);
      ctx.fillStyle = th.card2;
      ctx.fill();
      ctx.strokeStyle = "rgba(255,255,255,.10)";
      ctx.lineWidth = 2;
      ctx.stroke();
    });

    ctx.fillStyle = th.ink;
    ctx.font = "900 26px ui-sans-serif, system-ui";
    ctx.textAlign = "left";
    ctx.fillText("Lyrics / Memo", box.x+46, box.y+72);

    ctx.fillStyle = th.muted;
    ctx.font = "700 22px ui-sans-serif, system-ui";

    const lines = (state.lyrics || "").split("\n").map(s=>s.trimEnd());
    const maxLines = state.template==="landscape" ? 18 : 14;
    const shown = lines.slice(0, maxLines);

    let ty = box.y + 120;
    const lineH = 34;
    const wrapWidth = box.w - 92;

    for (const ln0 of shown){
      const wrapped = wrapLine(ln0, wrapWidth);
      for (const piece of wrapped){
        ctx.fillText(piece, box.x+46, ty);
        ty += lineH;
        if (ty > box.y + box.h - 66) break;
      }
      if (ty > box.y + box.h - 66) break;
    }

    ctx.fillStyle = "rgba(170,178,213,.60)";
    ctx.font = "700 16px ui-sans-serif, system-ui";
    ctx.fillText("â€»å…±æœ‰ã™ã‚‹å ´åˆã¯çŸ­ã„å¼•ç”¨ã§ï¼ˆæ¨©åˆ©é…æ…®ï¼‰", box.x+46, box.y+box.h-32);
  }

  function wrapLine(text, maxWidth){
    if(!text) return [""];
    const words = text.split(/(\s+)/); // keep spaces
    let buf = "";
    const out = [];
    for(const w of words){
      const test = buf + w;
      if(ctx.measureText(test).width > maxWidth && buf.trim().length){
        out.push(buf.trimEnd());
        buf = w.trimStart();
      } else {
        buf = test;
      }
    }
    out.push(buf.trimEnd());
    return out;
  }

  function drawEllipsis(text, x, y, maxW){
    let t = String(text);
    if(ctx.measureText(t).width <= maxW){
      ctx.fillText(t, x, y);
      return;
    }
    const ell = "â€¦";
    while(t.length > 1 && ctx.measureText(t + ell).width > maxW){
      t = t.slice(0, -1);
    }
    ctx.fillText(t + ell, x, y);
  }

  function iconPrev(x,y,color){
    ctx.save();
    ctx.translate(x,y);
    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.moveTo(10,0); ctx.lineTo(34,16); ctx.lineTo(34,-16); ctx.closePath();
    ctx.fill();
    ctx.fillRect(0,-16,8,32);
    ctx.restore();
  }
  function iconPlay(x,y,color,inner){
    ctx.save();
    ctx.translate(x,y);
    ctx.beginPath();
    ctx.arc(0,0,34,0,Math.PI*2);
    ctx.fillStyle = color;
    ctx.fill();
    ctx.fillStyle = inner;
    ctx.beginPath();
    ctx.moveTo(-8,-14); ctx.lineTo(16,0); ctx.lineTo(-8,14); ctx.closePath();
    ctx.fill();
    ctx.restore();
  }
  function iconNext(x,y,color){
    ctx.save();
    ctx.translate(x,y);
    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.moveTo(-10,0); ctx.lineTo(-34,16); ctx.lineTo(-34,-16); ctx.closePath();
    ctx.fill();
    ctx.fillRect(0,-16,8,32);
    ctx.restore();
  }

  function render(){
    const th = THEMES[state.theme];
    applyThemeToCSS();
    applyTemplate();

    const boxes = layout();

    drawBackground(th);
    drawPlayerCard(th, boxes.player);
    drawLyricsCard(th, boxes.lyrics);

    $("status").textContent = coverImg ? "cover: èª­ã¿è¾¼ã¿OK" : "cover: æœªé¸æŠ";
  }

  // ---------- state sync ----------
  function syncInputsFromState(){
    $("title").value = state.title ?? "";
    $("artist").value = state.artist ?? "";
    $("duration").value = state.duration ?? 180;
    $("pos").value = state.pos ?? 0;
    $("lyrics").value = state.lyrics ?? "";
    paintChips("template", state.template);
    paintChips("theme", state.theme);
  }

  function syncStateFromInputs(){
    state.title = $("title").value.trim();
    state.artist = $("artist").value.trim();
    state.duration = Number($("duration").value || 180);
    state.pos = Number($("pos").value || 0);
    state.lyrics = $("lyrics").value;
  }

  function saveState(){
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }catch(e){}
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return;
      const obj = JSON.parse(raw);
      if(obj && typeof obj === "object"){
        state = { ...state, ...obj };
        if(!TEMPLATES[state.template]) state.template = "portrait";
        if(!THEMES[state.theme]) state.theme = "dark";
      }
    }catch(e){}
  }

  function paintChips(group, value){
    document.querySelectorAll(`.chip[data-${group}]`).forEach(el=>{
      el.classList.toggle("on", el.dataset[group] === value);
    });
  }

  // ---------- events ----------
  // chips
  document.querySelectorAll(".chip[data-template]").forEach(el=>{
    el.addEventListener("click", ()=>{
      state.template = el.dataset.template;
      paintChips("template", state.template);
      saveState();
      render();
    });
  });
  document.querySelectorAll(".chip[data-theme]").forEach(el=>{
    el.addEventListener("click", ()=>{
      state.theme = el.dataset.theme;
      paintChips("theme", state.theme);
      saveState();
      render();
    });
  });

  // inputs auto-save & re-render (è»½ã‚ã«)
  const inputs = ["title","artist","duration","pos","lyrics"];
  let raf = 0;
  inputs.forEach(id=>{
    $(id).addEventListener("input", ()=>{
      cancelAnimationFrame(raf);
      raf = requestAnimationFrame(()=>{
        syncStateFromInputs();
        saveState();
        render();
      });
    });
  });

  // cover
  $("cover").addEventListener("change", (e)=>{
    const file = e.target.files?.[0];
    if(!file){ coverImg=null; render(); return; }
    const url = URL.createObjectURL(file);
    const img = new Image();
    img.onload = ()=>{
      coverImg = img;
      URL.revokeObjectURL(url);
      render();
    };
    img.onerror = ()=>{
      coverImg = null;
      render();
    };
    img.src = url;
    $("status").textContent = "cover: èª­ã¿è¾¼ã¿ä¸­â€¦";
  });

  // buttons
  $("render").addEventListener("click", ()=>{
    syncStateFromInputs();
    saveState();
    render();
  });

  $("download").addEventListener("click", ()=>{
    syncStateFromInputs();
    saveState();
    render();
    const a = document.createElement("a");
    const safe = (state.title || "music-card").replace(/[\\/:*?"<>|]/g,"_");
    a.download = `${safe}_${state.template}_${state.theme}.png`;
    a.href = cvs.toDataURL("image/png");
    a.click();
  });

  $("reset").addEventListener("click", ()=>{
    state = {
      template: "portrait",
      theme: "dark",
      title: "æ˜¥é›·",
      artist: "ç±³æ´¥ç„å¸«",
      duration: 206,
      pos: 103,
      lyrics: "ä¾‹ãˆã°ã€ã“ã“ã«çŸ­ã„å¼•ç”¨ã‚„ãƒ¡ãƒ¢ã‚’å…¥ã‚Œã‚‹ã€‚\nè¡Œã§ãã‚Œã£ã½ããªã‚‹ã€‚\nï¼ˆå…±æœ‰ã™ã‚‹ãªã‚‰çŸ­ã‚æ¨å¥¨ï¼‰"
    };
    coverImg = null;
    $("cover").value = "";
    saveState();
    syncInputsFromState();
    render();
  });

  // init
  loadState();
  syncInputsFromState();
  applyThemeToCSS();
  render();
</script>
</body>
</html>
